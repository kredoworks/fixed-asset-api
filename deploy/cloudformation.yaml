AWSTemplateFormatVersion: '2010-09-09'
Description: 'Fixed Asset Verification API - One-Click Deployment'

Parameters:
  KeyName:
    Description: EC2 Key Pair for SSH access
    Type: AWS::EC2::KeyPair::KeyName

  InstanceType:
    Description: EC2 instance type
    Type: String
    Default: t3.small
    AllowedValues:
      - t2.micro
      - t2.small
      - t3.micro
      - t3.small
      - t3.medium

  APIPort:
    Description: Port for the API
    Type: Number
    Default: 7400
    MinValue: 1024
    MaxValue: 65535

  AllowedIP:
    Description: IP range for SSH access (0.0.0.0/0 for anywhere)
    Type: String
    Default: 0.0.0.0/0

Mappings:
  RegionAMI:
    us-east-1:
      AMI: ami-0c7217cdde317cfec
    us-east-2:
      AMI: ami-05fb0b8c1424f266b
    us-west-1:
      AMI: ami-0ce2cb35386fc22e9
    us-west-2:
      AMI: ami-008fe2fc65df48dac
    eu-west-1:
      AMI: ami-0905a3c97561e0b69
    eu-central-1:
      AMI: ami-0faab6bdbac9486fb
    ap-south-1:
      AMI: ami-03f4878755434977f
    ap-southeast-1:
      AMI: ami-078c1149d8ad719a7
    ap-northeast-1:
      AMI: ami-07c589821f2b353aa

Resources:
  APISecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Fixed Asset API Security Group
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedIP
        - IpProtocol: tcp
          FromPort: !Ref APIPort
          ToPort: !Ref APIPort
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: fixed-asset-api-sg

  APIInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionAMI, !Ref 'AWS::Region', AMI]
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyName
      SecurityGroups:
        - !Ref APISecurityGroup
      Tags:
        - Key: Name
          Value: fixed-asset-api
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          exec > >(tee /var/log/user-data.log) 2>&1
          set -ex

          export DEBIAN_FRONTEND=noninteractive
          export API_PORT="${APIPort}"

          echo "=========================================="
          echo "Fixed Asset API - Deployment Starting"
          echo "Port: $API_PORT"
          echo "=========================================="

          # Update and install Docker
          apt-get update -qq
          apt-get install -y -qq docker.io docker-compose git
          systemctl enable docker
          systemctl start docker

          # Wait for docker
          sleep 5

          # Clone repo
          cd /opt
          git clone --depth 1 -b v2 https://github.com/kredoworks/fixed-asset-api.git app
          cd app

          # Verify Dockerfile has correct poetry command
          echo "Checking Dockerfile..."
          grep -q "only main" Dockerfile && echo "Dockerfile OK" || {
            echo "Fixing Dockerfile..."
            sed -i 's/--no-dev/--only main/g' Dockerfile
          }

          # Generate secure passwords
          DB_PASS=$(openssl rand -hex 16)
          SECRET_KEY=$(openssl rand -hex 32)

          # Create .env
          cat > .env << ENVFILE
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=$DB_PASS
          POSTGRES_DB=fixed_asset_db
          DATABASE_URL=postgresql+asyncpg://postgres:$DB_PASS@db:5432/fixed_asset_db
          SECRET_KEY=$SECRET_KEY
          CORS_ORIGINS=["*"]
          ACCESS_TOKEN_EXPIRE_MINUTES=1440
          REFRESH_TOKEN_EXPIRE_DAYS=7
          ENVFILE

          # Update docker-compose port
          sed -i "s/8000:8000/$API_PORT:8000/g" docker-compose.yml

          # Build and deploy
          echo "Building containers..."
          docker-compose build --no-cache

          echo "Starting database..."
          docker-compose up -d db

          echo "Waiting for database..."
          sleep 15

          echo "Initializing database..."
          docker-compose run --rm db-init || echo "Init completed"

          echo "Starting API..."
          docker-compose up -d api

          # Wait and verify
          sleep 10

          PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)

          echo "=========================================="
          echo "Deployment Complete!"
          echo "API: http://$PUBLIC_IP:$API_PORT"
          echo "Docs: http://$PUBLIC_IP:$API_PORT/docs"
          echo "=========================================="

          # Test
          curl -s http://localhost:$API_PORT/health || echo "Health check pending..."

  APIElasticIP:
    Type: AWS::EC2::EIP
    Properties:
      InstanceId: !Ref APIInstance
      Tags:
        - Key: Name
          Value: fixed-asset-api-eip

Outputs:
  APIURL:
    Description: API URL
    Value: !Sub 'http://${APIElasticIP}:${APIPort}'

  APIDocs:
    Description: Swagger Documentation
    Value: !Sub 'http://${APIElasticIP}:${APIPort}/docs'

  SSHCommand:
    Description: SSH Access
    Value: !Sub 'ssh -i ${KeyName}.pem ubuntu@${APIElasticIP}'

  Credentials:
    Description: Test Login
    Value: 'admin@company.com / admin123'
