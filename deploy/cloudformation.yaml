AWSTemplateFormatVersion: '2010-09-09'
Description: 'Fixed Asset Verification API - One-Click Deployment (Pre-built Image)'

# =============================================================================
# ONE-CLICK DEPLOYMENT
#
# Uses pre-built Docker image from GitHub Container Registry
# No build step = faster & more reliable deployment
#
# 1. Go to AWS CloudFormation Console
# 2. Create Stack -> Upload this template
# 3. Fill parameters -> Create
# 4. Wait ~3 minutes -> Done!
# =============================================================================

Parameters:
  KeyName:
    Description: EC2 Key Pair for SSH access
    Type: AWS::EC2::KeyPair::KeyName

  InstanceType:
    Description: EC2 instance type
    Type: String
    Default: t3.small
    AllowedValues:
      - t2.micro
      - t2.small
      - t3.micro
      - t3.small
      - t3.medium

  APIPort:
    Description: Port for the API
    Type: Number
    Default: 7400
    MinValue: 1024
    MaxValue: 65535

  AllowedIP:
    Description: IP range for SSH access (0.0.0.0/0 for anywhere)
    Type: String
    Default: 0.0.0.0/0

Mappings:
  RegionAMI:
    us-east-1:
      AMI: ami-0c7217cdde317cfec
    us-east-2:
      AMI: ami-05fb0b8c1424f266b
    us-west-1:
      AMI: ami-0ce2cb35386fc22e9
    us-west-2:
      AMI: ami-008fe2fc65df48dac
    eu-west-1:
      AMI: ami-0905a3c97561e0b69
    eu-central-1:
      AMI: ami-0faab6bdbac9486fb
    ap-south-1:
      AMI: ami-03f4878755434977f
    ap-southeast-1:
      AMI: ami-078c1149d8ad719a7
    ap-northeast-1:
      AMI: ami-07c589821f2b353aa

Resources:
  APISecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Fixed Asset API Security Group
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedIP
        - IpProtocol: tcp
          FromPort: !Ref APIPort
          ToPort: !Ref APIPort
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: fixed-asset-api-sg

  APIInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [RegionAMI, !Ref 'AWS::Region', AMI]
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyName
      SecurityGroups:
        - !Ref APISecurityGroup
      Tags:
        - Key: Name
          Value: fixed-asset-api
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          exec > >(tee /var/log/user-data.log) 2>&1
          set -ex

          echo "=== Fixed Asset API Deployment ==="
          echo "Port: ${APIPort}"

          # Install Docker
          apt-get update -qq
          apt-get install -y docker.io docker-compose
          systemctl enable docker
          systemctl start docker

          # Generate credentials
          DB_PASS=$(openssl rand -hex 16)
          SECRET=$(openssl rand -hex 32)

          # Create app directory
          mkdir -p /opt/api
          cd /opt/api

          # Create docker-compose.yml directly (no git clone needed)
          cat > docker-compose.yml << 'COMPOSE'
          version: '3.8'
          services:
            db:
              image: postgres:15-alpine
              restart: unless-stopped
              environment:
                POSTGRES_USER: postgres
                POSTGRES_PASSWORD: ${DB_PASSWORD}
                POSTGRES_DB: fixed_asset_db
              volumes:
                - pgdata:/var/lib/postgresql/data
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U postgres"]
                interval: 5s
                timeout: 5s
                retries: 10

            api:
              image: ghcr.io/kredoworks/fixed-asset-api:v2
              restart: unless-stopped
              depends_on:
                db:
                  condition: service_healthy
              environment:
                DATABASE_URL: postgresql+asyncpg://postgres:${DB_PASSWORD}@db:5432/fixed_asset_db
                SECRET_KEY: ${SECRET_KEY}
                CORS_ORIGINS: '["*"]'
              ports:
                - "${API_PORT}:8000"

            init:
              image: ghcr.io/kredoworks/fixed-asset-api:v2
              depends_on:
                db:
                  condition: service_healthy
              environment:
                DATABASE_URL: postgresql+asyncpg://postgres:${DB_PASSWORD}@db:5432/fixed_asset_db
                SECRET_KEY: ${SECRET_KEY}
              command: python reset_db.py --seed
              restart: "no"

          volumes:
            pgdata:
          COMPOSE

          # Create .env file
          cat > .env << EOF
          DB_PASSWORD=$DB_PASS
          SECRET_KEY=$SECRET
          API_PORT=${APIPort}
          EOF

          # Pull and start
          docker-compose pull
          docker-compose up -d db
          sleep 10
          docker-compose run --rm init
          docker-compose up -d api

          echo "=== Deployment Complete ==="
          echo "URL: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4):${APIPort}"

  APIElasticIP:
    Type: AWS::EC2::EIP
    Properties:
      InstanceId: !Ref APIInstance
      Tags:
        - Key: Name
          Value: fixed-asset-api-eip

Outputs:
  APIURL:
    Description: API URL
    Value: !Sub 'http://${APIElasticIP}:${APIPort}'

  APIDocs:
    Description: Swagger Documentation
    Value: !Sub 'http://${APIElasticIP}:${APIPort}/docs'

  SSHCommand:
    Description: SSH Access
    Value: !Sub 'ssh -i ${KeyName}.pem ubuntu@${APIElasticIP}'

  Credentials:
    Description: Test Login
    Value: 'admin@company.com / admin123'
